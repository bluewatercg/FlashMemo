name: Build Flutter APK

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# çŽ¯å¢ƒå˜é‡
env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è®¾ç½®JavaçŽ¯å¢ƒ
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. å®‰è£…Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    # 4. ç¦ç”¨Flutteråˆ†æžå¹¶éªŒè¯å®‰è£…
    - name: Configure Flutter and verify installation
      run: |
        flutter config --no-analytics
        flutter --disable-analytics
        flutter --version
        flutter doctor -v

    # 5. èŽ·å–ä¾èµ–
    - name: Get dependencies
      run: flutter pub get

    # 6. æž„å»ºAPKï¼ˆä»…æž„å»ºé€šç”¨ç‰ˆæœ¬ä»¥é¿å…å¤æ‚æ€§ï¼‰
    - name: Build APK
      run: |
        flutter build apk --release

    # 7. é‡å‘½åAPKæ–‡ä»¶
    - name: Rename APK files
      run: |
        cd build/app/outputs/flutter-apk/
        mv app-release.apk FlashMemo-v${{ github.run_number }}.apk
        ls -la

    # 8. ä¸Šä¼ APKæ–‡ä»¶ä½œä¸ºArtifacts
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlashMemo-APK-${{ github.run_number }}
        path: |
          build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk
        retention-days: 30

    # 9. åˆ›å»ºReleaseï¼ˆå¯é€‰ï¼Œä»…åœ¨æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶ï¼‰
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: FlashMemo v1.0.${{ github.run_number }}
        body: |
          ðŸŽ‰ FlashMemo ç§»åŠ¨ç«¯é—ªå¡åº”ç”¨æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ## ðŸ“± å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°Androidè®¾å¤‡
          2. å¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          
          ## ðŸ”„ ç‰ˆæœ¬ä¿¡æ¯
          - æž„å»ºå·: ${{ github.run_number }}
          - æäº¤: ${{ github.sha }}
          
          è‡ªåŠ¨æž„å»ºæ—¶é—´: $(date)
        files: |
          build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 10. æž„å»ºä¿¡æ¯æ€»ç»“
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- æž„å»ºå·: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk" ]; then
          cd build/app/outputs/flutter-apk/
          size=$(du -h "FlashMemo-v${{ github.run_number }}.apk" | cut -f1)
          echo "### ðŸ“¦ ç”Ÿæˆçš„APKæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          echo "- FlashMemo-v${{ github.run_number }}.apk ($size)" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ APKæ–‡ä»¶ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi