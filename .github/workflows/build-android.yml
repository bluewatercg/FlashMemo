name: Build Flutter APK

# 触发条件
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发

# 环境变量
env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置Java环境
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. 安装Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    # 4. 禁用Flutter分析并验证安装
    - name: Configure Flutter and verify installation
      run: |
        flutter config --no-analytics
        flutter --disable-analytics
        flutter --version
        flutter doctor -v

    # 5. 获取依赖
    - name: Get dependencies
      run: flutter pub get

    # 6. 构建APK（仅构建通用版本以避免复杂性）
    - name: Build APK
      run: |
        flutter build apk --release

    # 7. 重命名APK文件
    - name: Rename APK files
      run: |
        cd build/app/outputs/flutter-apk/
        mv app-release.apk FlashMemo-v${{ github.run_number }}.apk
        ls -la

    # 8. 上传APK文件作为Artifacts
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlashMemo-APK-${{ github.run_number }}
        path: |
          build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk
        retention-days: 30

    # 9. 创建Release（可选，仅在推送到main分支时）
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: FlashMemo v1.0.${{ github.run_number }}
        body: |
          🎉 FlashMemo 移动端闪卡应用新版本发布！
          
          ## 📱 安装说明
          1. 下载APK文件到Android设备
          2. 启用"未知来源"安装
          3. 点击APK文件进行安装
          
          ## 📋 系统要求
          - Android 5.0 (API 21) 或更高版本
          
          ## 🔄 版本信息
          - 构建号: ${{ github.run_number }}
          - 提交: ${{ github.sha }}
          
          自动构建时间: $(date)
        files: |
          build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 10. 构建信息总结
    - name: Build Summary
      if: always()
      run: |
        echo "## 🏗️ 构建完成" >> $GITHUB_STEP_SUMMARY
        echo "- 构建号: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Flutter版本: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- 分支: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- 提交: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "build/app/outputs/flutter-apk/FlashMemo-v${{ github.run_number }}.apk" ]; then
          cd build/app/outputs/flutter-apk/
          size=$(du -h "FlashMemo-v${{ github.run_number }}.apk" | cut -f1)
          echo "### 📦 生成的APK文件:" >> $GITHUB_STEP_SUMMARY
          echo "- FlashMemo-v${{ github.run_number }}.apk ($size)" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ APK文件生成失败" >> $GITHUB_STEP_SUMMARY
        fi