name: Build Flutter APK

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# çŽ¯å¢ƒå˜é‡
env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è®¾ç½®JavaçŽ¯å¢ƒ
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. å®‰è£…Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    # 4. éªŒè¯Flutterå®‰è£…
    - name: Verify Flutter installation
      run: |
        flutter --version
        flutter doctor -v

    # 5. èŽ·å–ä¾èµ–
    - name: Get dependencies
      run: flutter pub get

    # 6. è¿è¡Œé™æ€åˆ†æž
    - name: Analyze code
      run: flutter analyze

    # 7. è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰
    - name: Run tests
      run: flutter test --coverage
      continue-on-error: true

    # 8. æž„å»ºAPK
    - name: Build APK
      run: |
        flutter build apk --release --split-per-abi
        flutter build apk --release --target-platform android-arm64

    # 9. é‡å‘½åAPKæ–‡ä»¶
    - name: Rename APK files
      run: |
        cd build/app/outputs/flutter-apk/
        mv app-arm64-v8a-release.apk flashmemo-arm64-v8a-${{ github.run_number }}.apk || true
        mv app-armeabi-v7a-release.apk flashmemo-armeabi-v7a-${{ github.run_number }}.apk || true
        mv app-x86_64-release.apk flashmemo-x86_64-${{ github.run_number }}.apk || true
        mv app-release.apk flashmemo-universal-${{ github.run_number }}.apk || true
        ls -la

    # 10. ä¸Šä¼ APKæ–‡ä»¶ä½œä¸ºArtifacts
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flashmemo-apk-${{ github.run_number }}
        path: |
          build/app/outputs/flutter-apk/*.apk
        retention-days: 30

    # 11. åˆ›å»ºReleaseï¼ˆå¯é€‰ï¼Œä»…åœ¨æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶ï¼‰
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: FlashMemo v1.0.${{ github.run_number }}
        body: |
          ðŸŽ‰ FlashMemo ç§»åŠ¨ç«¯é—ªå¡åº”ç”¨æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ## ðŸ“± ä¸‹è½½è¯´æ˜Ž
          - **arm64-v8a**: é€‚ç”¨äºŽå¤§å¤šæ•°çŽ°ä»£Androidè®¾å¤‡ï¼ˆæŽ¨èï¼‰
          - **armeabi-v7a**: é€‚ç”¨äºŽè¾ƒè€çš„32ä½ARMè®¾å¤‡
          - **x86_64**: é€‚ç”¨äºŽx86_64æ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡
          - **universal**: é€šç”¨ç‰ˆæœ¬ï¼ˆåŒ…å«æ‰€æœ‰æž¶æž„ï¼Œæ–‡ä»¶è¾ƒå¤§ï¼‰
          
          ## ðŸ”„ æ›´æ–°å†…å®¹
          - æž„å»ºå·: ${{ github.run_number }}
          - æäº¤: ${{ github.sha }}
          
          ## ðŸ“‹ å®‰è£…è¦æ±‚
          - Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          
          è‡ªåŠ¨æž„å»ºäºŽ: ${{ github.run_number }}
        files: |
          build/app/outputs/flutter-apk/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 12. æž„å»ºä¿¡æ¯æ€»ç»“
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- æž„å»ºå·: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ç”Ÿæˆçš„APKæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
        if [ -d "build/app/outputs/flutter-apk/" ]; then
          cd build/app/outputs/flutter-apk/
          for file in *.apk; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "- $file ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        fi